version: "3.3"

services:
  prometheus:
    image: prom/prometheus
    restart: always
    volumes:
      - /tmp/prometheus.yml:/etc/prometheus/prometheus.yml
      - prometheus-tsdb:/prometheus
    labels:
        traefik.port: "9090"
        traefik.backend: "prometheus"
        traefik.frontend.rule: "Host: <%= @prometheus_frontend_rule %>"
    #deploy:
    #  labels:
    #    traefik.port: 9090
    #    traefik.backend: "prometheus"
    #    traefik.frontend.rule: "Host: <%= @prometheus_frontend_rule %>"
  grafana:
    image: grafana/grafana:6.7.1
    depends_on:
      - prometheus
    restart: always
    volumes:
      - grafana-storage:/var/lib/grafana
    labels:
        traefik.port: "3000"
        traefik.backend: "grafana"
        traefik.frontend.rule: "Host: <%= @grafana_frontend_rule %>"
    #deploy:
    #  labels:
    #    traefik.port: 3000
    #    traefik.backend: "grafana"
    #    traefik.frontend.rule: "Host: <%= @grafana_frontend_rule %>"
  traefik:
    image: traefik:1.5
    command: --web --docker --logLevel=DEBUG
    restart: always
    ports:
      - "80:80"
      - "8080:8080"
      - "443:443"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - /dev/null:/etc/traefik/traefik.toml

volumes:
  prometheus-tsdb:
  grafana-storage:
