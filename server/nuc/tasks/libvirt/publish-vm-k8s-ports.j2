#!/bin/bash

VIRB_NIC=virbr1
GUEST_IP=$(dig @{{ libvirt_dns }} +short k8s.pck.internal)

if [ "${1}" = "vm-ubuntu-k8s" ]; then

   # Update the following variables to fit your setup
   GUEST_PORT=32080
   HOST_PORT=32080

   if [ "${2}" = "stopped" ] || [ "${2}" = "reconnect" ]; then
        /usr/sbin/iptables -D FORWARD -o $VIRB_NIC -p tcp -d $GUEST_IP --dport $GUEST_PORT -j ACCEPT
        /usr/sbin/iptables -t nat -D PREROUTING -p tcp --dport $HOST_PORT -j DNAT --to $GUEST_IP:$GUEST_PORT
   fi
   if [ "${2}" = "started" ] || [ "${2}" = "reconnect" ]; then
        /usr/sbin/iptables -I FORWARD -o $VIRB_NIC -p tcp -d $GUEST_IP --dport $GUEST_PORT -j ACCEPT
        /usr/sbin/iptables -t nat -I PREROUTING -p tcp --dport $HOST_PORT -j DNAT --to $GUEST_IP:$GUEST_PORT
   fi
fi

if [ "${1}" = "vm-ubuntu-k8s" ]; then

   # Update the following variables to fit your setup
   GUEST_PORT=32081
   HOST_PORT=32081

   if [ "${2}" = "stopped" ] || [ "${2}" = "reconnect" ]; then
        /usr/sbin/iptables -D FORWARD -o $VIRB_NIC -p tcp -d $GUEST_IP --dport $GUEST_PORT -j ACCEPT
        /usr/sbin/iptables -t nat -D PREROUTING -p tcp --dport $HOST_PORT -j DNAT --to $GUEST_IP:$GUEST_PORT
   fi
   if [ "${2}" = "started" ] || [ "${2}" = "reconnect" ]; then
        /usr/sbin/iptables -I FORWARD -o $VIRB_NIC -p tcp -d $GUEST_IP --dport $GUEST_PORT -j ACCEPT
        /usr/sbin/iptables -t nat -I PREROUTING -p tcp --dport $HOST_PORT -j DNAT --to $GUEST_IP:$GUEST_PORT
   fi
fi

if [ "${1}" = "vm-ubuntu-k8s" ]; then

   # Update the following variables to fit your setup
   GUEST_PORT=32443
   HOST_PORT=32443

   if [ "${2}" = "stopped" ] || [ "${2}" = "reconnect" ]; then
        /usr/sbin/iptables -D FORWARD -o $VIRB_NIC -p tcp -d $GUEST_IP --dport $GUEST_PORT -j ACCEPT
        /usr/sbin/iptables -t nat -D PREROUTING -p tcp --dport $HOST_PORT -j DNAT --to $GUEST_IP:$GUEST_PORT
   fi
   if [ "${2}" = "started" ] || [ "${2}" = "reconnect" ]; then
        /usr/sbin/iptables -I FORWARD -o $VIRB_NIC -p tcp -d $GUEST_IP --dport $GUEST_PORT -j ACCEPT
        /usr/sbin/iptables -t nat -I PREROUTING -p tcp --dport $HOST_PORT -j DNAT --to $GUEST_IP:$GUEST_PORT
   fi
fi

if [ "${1}" = "vm-ubuntu-k8s" ]; then

   # Update the following variables to fit your setup
   GUEST_PORT=30025
   HOST_PORT=30025

   if [ "${2}" = "stopped" ] || [ "${2}" = "reconnect" ]; then
        /usr/sbin/iptables -D FORWARD -o $VIRB_NIC -p tcp -d $GUEST_IP --dport $GUEST_PORT -j ACCEPT
        /usr/sbin/iptables -t nat -D PREROUTING -p tcp --dport $HOST_PORT -j DNAT --to $GUEST_IP:$GUEST_PORT
   fi
   if [ "${2}" = "started" ] || [ "${2}" = "reconnect" ]; then
        /usr/sbin/iptables -I FORWARD -o $VIRB_NIC -p tcp -d $GUEST_IP --dport $GUEST_PORT -j ACCEPT
        /usr/sbin/iptables -t nat -I PREROUTING -p tcp --dport $HOST_PORT -j DNAT --to $GUEST_IP:$GUEST_PORT
   fi
fi

if [ "${1}" = "vm-ubuntu-k8s" ]; then

   # Update the following variables to fit your setup
   GUEST_PORT=30993
   HOST_PORT=30993

   if [ "${2}" = "stopped" ] || [ "${2}" = "reconnect" ]; then
        /usr/sbin/iptables -D FORWARD -o $VIRB_NIC -p tcp -d $GUEST_IP --dport $GUEST_PORT -j ACCEPT
        /usr/sbin/iptables -t nat -D PREROUTING -p tcp --dport $HOST_PORT -j DNAT --to $GUEST_IP:$GUEST_PORT
   fi
   if [ "${2}" = "started" ] || [ "${2}" = "reconnect" ]; then
        /usr/sbin/iptables -I FORWARD -o $VIRB_NIC -p tcp -d $GUEST_IP --dport $GUEST_PORT -j ACCEPT
        /usr/sbin/iptables -t nat -I PREROUTING -p tcp --dport $HOST_PORT -j DNAT --to $GUEST_IP:$GUEST_PORT
   fi
fi

if [ "${1}" = "vm-ubuntu-k8s" ]; then

   # Update the following variables to fit your setup
   GUEST_PORT=30587
   HOST_PORT=30587

   if [ "${2}" = "stopped" ] || [ "${2}" = "reconnect" ]; then
        /usr/sbin/iptables -D FORWARD -o $VIRB_NIC -p tcp -d $GUEST_IP --dport $GUEST_PORT -j ACCEPT
        /usr/sbin/iptables -t nat -D PREROUTING -p tcp --dport $HOST_PORT -j DNAT --to $GUEST_IP:$GUEST_PORT
   fi
   if [ "${2}" = "started" ] || [ "${2}" = "reconnect" ]; then
        /usr/sbin/iptables -I FORWARD -o $VIRB_NIC -p tcp -d $GUEST_IP --dport $GUEST_PORT -j ACCEPT
        /usr/sbin/iptables -t nat -I PREROUTING -p tcp --dport $HOST_PORT -j DNAT --to $GUEST_IP:$GUEST_PORT
   fi
fi

if [ "${1}" = "vm-ubuntu-k8s" ]; then

   # Update the following variables to fit your setup (pihole)
   GUEST_PORT=30661
   HOST_PORT=30661

   if [ "${2}" = "stopped" ] || [ "${2}" = "reconnect" ]; then
        /usr/sbin/iptables -D FORWARD -i wlan0 -o $VIRB_NIC -p udp -d $GUEST_IP --dport $GUEST_PORT -j ACCEPT
        /usr/sbin/iptables -t nat -D PREROUTING -i wlan0 -p udp --dport $HOST_PORT -j DNAT --to $GUEST_IP:$GUEST_PORT

        /usr/sbin/iptables -D FORWARD -i wlan0 -o $VIRB_NIC -p tcp -d $GUEST_IP --dport $GUEST_PORT -j ACCEPT
        /usr/sbin/iptables -t nat -D PREROUTING -i wlan0 -p tcp --dport $HOST_PORT -j DNAT --to $GUEST_IP:$GUEST_PORT
   fi
   if [ "${2}" = "started" ] || [ "${2}" = "reconnect" ]; then
        /usr/sbin/iptables -I FORWARD -i wlan0 -o $VIRB_NIC -p udp -d $GUEST_IP --dport $GUEST_PORT -j ACCEPT
        /usr/sbin/iptables -t nat -I PREROUTING -i wlan0 -p udp --dport $HOST_PORT -j DNAT --to $GUEST_IP:$GUEST_PORT

        /usr/sbin/iptables -I FORWARD -i wlan0 -o $VIRB_NIC -p tcp -d $GUEST_IP --dport $GUEST_PORT -j ACCEPT
        /usr/sbin/iptables -t nat -I PREROUTING -i wlan0 -p tcp --dport $HOST_PORT -j DNAT --to $GUEST_IP:$GUEST_PORT
   fi
fi
